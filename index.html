<!DOCTYPE html>
<html lang="en">
	<head>
		<title>web Intonation</title>
		<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
		<link rel="stylesheet" href="https://unpkg.com/keyboard-css@1.2.4/dist/css/main.min.css" />
		<script src="https://cdn.jsdelivr.net/npm/mathjs@12.3.0/lib/browser/math.min.js"></script>
		
		<meta name="description" content="Free online simulator for hearing and developing musical tunings, temperaments and scales" />
		<meta property="og:type" content="website" />
		<meta property="og:url" content="https://flappix.github.io/web_intonation/" />

		<script type="text/javascript">
			function ScaleApp()
			{
				return {
					init: function()
					{
						this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
						this.volume = this.audioCtx.createGain();
						this.volume.connect (this.audioCtx.destination);
						this.volume.gain.value = 0.03;
					},
					
					oscillators: {},
					playing: [], // currently active notes
					volume: null,
					marker: null, // index of scale degree to highlight
					
					createOscillator: function() {
						let oscillator = this.audioCtx.createOscillator();	
						oscillator.type = 'sine';
						oscillator.connect (this.volume);
						
						return oscillator;
					},
					playNote: function (degree)
					{
						console.log ('degree', degree);
						if ( ! (degree in this.oscillators) )
						{
							this.oscillators[degree] = this.createOscillator();
							
							let scale = this.scales[this.curr_scale];
							let scale_length = this.scale_blends[this.curr_scale_blend].length;
						
							if (scale.type == 'relative')
							{
								// transform octaves
								let degree_adj = degree %  scale_length;
								let octave = Math.floor (degree / scale_length);
								
								console.log ('degree_adj', degree_adj);
								// evaluate math expr to frequency
								let freq = this.getFreq (degree_adj);
								if (freq)
								{
									this.oscillators[degree].frequency.value = (scale.root * freq) * (2 ** octave);
									this.oscillators[degree].start();
									this.playing.push (degree);
								}
							}
						}
					},
					
					stopNote: function (degree)
					{
						if (degree in this.oscillators)
						{
							this.oscillators[degree].stop();
							delete this.oscillators[degree];
							this.playing = this.playing.filter (d => d != degree);
						}
					},
					
					getFreq: function (degree)
					{
						console.log ('freq', degree);
						if (this.scale_blends[this.curr_scale_blend].length > this.scales[this.curr_scale].notes.length) this.curr_scale_blend = 'chromatic';
						
						try
						{
							console.log (this.scale_blends[this.curr_scale_blend][degree]);
							return math.evaluate ( String (this.scales[this.curr_scale].notes[this.scale_blends[this.curr_scale_blend][degree] - 1]) );
						}
						catch (e)
						{
							return null;
						}
					},
					
					stopAll: function()
					{
						for (let osc in this.oscillators)
						{
							this.stopNote (osc);
						}
					},
					
					curr_scale: 'just_intonation',
					scales: {					
						just_intonation: {
							type: 'relative',
							root: 440,
							notes: ['1', '1 + 1/15', '1 + 1/8', '1 + 1/5', '1 + 1/4', '1 + 1/3', '1 + 13/32', '1 + 1/2', '1 + 3/5', '1 + 2/3', '1 + 4/5',  '1 + 7/8']
						},
						
						equal_temperament: {
							type: 'relative',
							root: 440,
							notes: ['1', '2^(1/12)', '2^(2/12)',  '2^(3/12)',  '2^(4/12)', '2^(5/12)',  '2^(6/12)',  '2^(7/12)',  '2^(8/12)',  '2^(9/12)', '2^(10/12)',  '2^(11/12)']
						},
						
						pythagorean_tuning: {
							type: 'relative',
							root: 440,
							notes: ['1', '2^8 / 3^5', '3^2 / 2^3',  '2^5 / 3^3',  '3^4 / 2^6', '2^2 / 3',  '2^10 / 3^6',  /*'3^6 / 2^9', */ '3 / 2',  '2^7 / 3^4', '3^3 / 2^4',  '2^4 / 3^2', '3^5 / 2^7']
						},
						
						meantone_temperament: {
							type: 'relative',
							root: 440,
							notes: ['1', '5/16 * ', '3^2 / 2^3',  '2^5 / 3^3',  '3^4 / 2^6', '2^2 / 3',  '2^10 / 3^6',  /*'3^6 / 2^9', */ '3 / 2',  '2^7 / 3^4', '3^3 / 2^4',  '2^4 / 3^2', '3^5 / 2^7']
						},
						
						harmonic_series: {
							type: 'relative',
							root: 440,
							notes: ['1', '1 + 1/7', '1 + 1/6', '1 + 1/5', '1 + 1/4', '1 + 1/3', '1 + 1/2', '1 + 2/3', '1 + 3/4', '1 + 4/5', '1 + 5/6', '1 + 6/7']
						},
						
						custom_equal_scale: {
							type: 'relative',
							root: 420,
							notes: ['1', '1 + 1/7', '1 + 2/7', '1 + 3/7', '1 + 4/7', '1 + 5/7', '1 + 6/7']
						},
						
						
						custom_spooky: {
							type: 'relative',
							root: 210,
							notes: [1/1, 1.6, 1.87]
						},
					},
					curr_scale_blend: 'major',
					scale_blends: {
						'major': [1, 3, 5, 6, 8, 10, 12],
						'natural minor': [1, 3, 4, 6, 8, 9, 11],
						'harmonic minor': [1, 3, 4, 6, 8, 9, 12],
						'chromatic': [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
					},
					
					add_scale_degree: function (pos)
					{
						let notes = this.scales[this.curr_scale].notes;
						this.scales[this.curr_scale].notes.splice (pos + 1, 0, notes[pos]);
						this.marker = pos + 1;
						
						setTimeout ( () => {
							this.marker = null;
						}, 1500);
					},
					
					add_keymap_degree: function()
					{
						let keys = Object.keys (this.key_maps[this.curr_keymap]);
						let last = keys[keys.length - 1];
						this.key_maps[this.curr_keymap][parseInt (last) + 1] = '';
					},
					
					
					// todo: turn scales into arrays
					curr_keymap: 'scale',
					key_maps: {
						scale: {
							0:'a' ,
							1:'s' ,
							2:'d' ,
							3:'f' ,
							4:'g' ,
							5:'h' ,
							6:'j' ,
							
							7: 'k,z,y',
							8: 'l,x',
							9: 'c',
							10: 'v',
							11: 'b',
							12: 'n',
							13: 'm',
							
						},
						chords: {
							0:'a,f,h' ,
							1:'s,g,j' ,
							2:'a,d,h' ,
							3:'s,f,j' ,
							4:'a,d,g' ,
							5:'s,f,h' ,
							6:'j,d,g' ,
							
							7: 'z,y',
							8: 'x',
							9: 'c',
							10: 'v',
							11: 'b',
							12: 'n',
							13: 'm',
						}
					},
					
					degree2Note: function (degree)
					{
						let r = this.scales[this.curr_scale].notes[this.scale_blends[this.curr_scale_blend][degree]];
						console.log ('convert degree 2 note', degree, r);
						return r;
					},
					
					note2Degree: function (note)
					{
						let r = this.scale_blends[this.curr_scale_blend].map (x => x - 1).indexOf (note);
						console.log ('convert note 2 degree', note, r);
						return r;
					},
					
					get_note_by_key: function (keyChar)
					{
						return Object.keys (this.key_maps[this.curr_keymap]).filter (key => this.key_maps[this.curr_keymap][key].split (',').includes (keyChar) );//.map ( k => this.scale_blends[this.curr_scale_blend][k] - 1 );
					},
					
					key_check_on: function (event)
					{
						let notes = this.get_note_by_key (event.key);
						console.log ('play degrees', notes);
						for (let note of notes)
						{
							this.playNote (note);
						}
					},
					
					key_check_off: function (event)
					{
						//this.key_check (event, this.stopNote);
						let notes = this.get_note_by_key (event.key);
						for (let note of notes)
						{
							this.stopNote (note);
						}
					}
				};
			}
			
			/*Alpine.directive('debug', (el, { expression }, { evaluate }) => {
				el.style.backgroundColor = 'black'; 
				el.style.fontFamily = 'monospace'; 
				el.style.color = 'lightgreen'; 
				el.style.fontWeight = 'bold'; 
				el.style.padding = '0.5em'; 
				el.style.whiteSpace = 'pre'; 
				
				let v = evaluate (expression);
				console.log (v);
				el.textContent = JSON.stringify (v, null, 2);
			});*/
		</script>

		<style>
			@keyframes myAnim {
				0% {
					animation-timing-function: ease-in;
					opacity: 1;
					transform: translateY(45px);
				}

				24% {
					opacity: 1;
				}

				40% {
					animation-timing-function: ease-in;
					transform: translateY(24px);
				}

				65% {
					animation-timing-function: ease-in;
					transform: translateY(12px);
				}

				82% {
					animation-timing-function: ease-in;
					transform: translateY(6px);
				}

				93% {
					animation-timing-function: ease-in;
					transform: translateY(4px);
				}

				25%,
				55%,
				75%,
				87% {
					animation-timing-function: ease-out;
					transform: translateY(0px);
				}

				100% {
					animation-timing-function: ease-out;
					opacity: 1;
					transform: translateY(0px);
				}
			}
			
			body {
				background-color: #F2F2F2;
			}
			
			.box {
				background-color: white;
			}
			
			div
			{
				border-radius: 0.3em;
			}
			
			button {
				cursor: pointer;
			}
			
			.playing {
				background-color: lightblue;
			}
			
			.setting
			{
				margin: 0.5em;
				align-items: center;
				display: flex;
				background-color: #F2F2F2;
				padding: 0.5em;
			}
			
			.link {
				background-color: #E2E2E2;
				border-radius: 0.3em;
				margin: 0.2em;
				padding: 0 0.3em 0 0.3em;
				display: flex;
				align-items: center;
				box-shadow: 2px 2px 5px #929292;
			}
		</style>
	</head>

	<body x-data="ScaleApp()" x-on:keydown="key_check_on" x-on:keyup="key_check_off">
		<div style="display: flex; justify-content: space-between;">
			<div style="font-weight: bold; font-size: 2em;">			
				Musical Tuing Simulator
				<span style="display: none;">Free online simulator for hearing and developing musical tunings, temperaments and scales. Supports just intonation, equal temperament and custom tuning systems.</span>
			</div>
			<div style="display: flex; align-items: center; border: 1px solid black; padding: 0.5em; margin: 0.5em;" class="box">
				<div class="setting">
					<span style="margin-right: 0.2em;">Tuning</span>
					<select x-model="curr_scale">
						<template x-for="name in Object.keys (scales)">
							<option x-html="name"></option>
						</template>
					</select>
				</div>
				<div class="setting">
					<span style="margin-right: 0.2em;">Scale</span>
					<select x-model="curr_scale_blend" :disabled="scales[curr_scale].notes.length < scale_blends[curr_scale_blend].length">
						<template x-for="name in Object.keys (scale_blends)">
							<option x-html="name"></option>
						</template>
					</select>
				</div>
				<div class="setting">
					<span style="margin-right: 0.2em;">Root</span>
					<input type="number" x-model="scales[curr_scale].root" style="width: 4em; margin-right: 0.2em;" /> Hz
				</div>
				
				<div class="setting">
					<span style="margin-right: 0.2em;">Keyboard</span>
					<select x-model="curr_keymap">
						<template x-for="name in Object.keys (key_maps)">
							<option x-html="name"></option>
						</template>
					</select>
				</div>
				<!--<div>
					<span>Scale Type</span>:
					<span x-html="scales[curr_scale].type"></span>
				</div>-->
			
				<div class="setting">
					<span style="margin-right: 0.2em;">Volume</span>
					<input type="range" min="0" max="1" step="0.01" x-model="volume.gain.value" />
				</div>
			</div>
			<div style="display: flex; align-items: stretch;">
				<a href="https://github.com/flappix/web_intonation" class="link" title="this project on github"><svg style="width: 2.5em;" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="32" data-view-component="true" class="octicon octicon-mark-github v-align-middle color-fg-default"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"></path></svg></a>
				<a href="https://flappix.github.io/webchords/" class="link" style="font-weight: bold; color: black; text-decoration: none;" title="Online tool for creating and looping jazzy chord progressions on the fly">WebChords</a>
				<a href="https://soundcloud.com/user-21721742" class="link" title="my music on soundcloud"><img style="width: 3em;" src="https://d21buns5ku92am.cloudfront.net/26628/images/419677-sc-logo-vertical-black%20%281%29-81a8fc-medium-1645807040.png" /></a>
			</div>
		</div>
		<div>
			<div>
				<span style="font-weight: bold;">Scale</span>
				<div style="display: flex; width: 100%; flex-wrap: wrap; align-self: stretch; justify-content: stretch;">
					<template x-for="(note, n) in scale_blends[curr_scale_blend].map (x => scales[curr_scale].notes[x])">
						<div style="border: 1px solid black; margin: 0.5em; padding: 0.5em; width: 10%;" :style="{'animation': marker == n ? 'myAnim 1s ease-in-out 0s 1 normal forwards' : 'none'}"
							 class="box"
							 :class="{'playing': playing.map (p => p % scale_blends[curr_scale_blend].length).includes (n % scale_blends[curr_scale_blend].length ) }">
							<!--<div x-html="n"></div>
							<div x-html="n % scales[curr_scale].notes.length"></div>
							<div x-html="JSON.stringify ( playing.map (p => p % scales[curr_scale].notes.length))"></div>
							<div x-html="JSON.stringify (playing.includes (n))"></div>
							<div x-html="JSON.stringify (marker)"></div>-->
							<div style="display: flex; justify-content: space-between;">
								<div style="border: 1px solid black; padding: 5px;" x-html="n + 1"></div>
								<div style="display: flex; flex-wrap: nowrap; align-items: center; margin: 0; padding: 0;">
									<button x-on:click="scale_blends[curr_scale_blend].splice (n, 1);" title="delete" style="font-family: monospace;">x</button>
									<button x-on:click="add_scale_degree (n)" style=" margin-left: 0.2em;" title="add scale degree">+</button>
								</div>
							</div>
							<div style="display: flex;">
								<span style="width: 50%;">ratio</span>
								<!--<input type="number"
									   x-model="scales[curr_scale].notes[n]"
									   step="0.01"
									   :max="n < scales[curr_scale].notes.length ? scales[curr_scale].notes[n + 1]: 1"
									   style="width: 50%;" />-->

								<input type="text"
									   x-model="scales[curr_scale].notes[n]"
									   style="width: 50%; text-align: end;" :style="{'background-color': getFreq (n) == null ? 'red' : 'none'}" />
							</div>
							<div style="display: flex; align-items: center; justify-content: space-between;">
								<span style="width: 50%;">freq</span>
								<span style="font-family: monospace;" x-html="parseFloat ( String (scales[curr_scale].root * getFreq (n) ) ).toFixed(2);"></span> Hz
							</div>
							<!--<input type="text" x-model="key_maps[curr_keymap][n]" />-->
						</div>
					</template>
					<button x-on:click="add_scale_degree (scale_blends[curr_scale_blend].length - 1)" style="cursor: pointer; margin: 0.5em;" title="add scale degree">+</button>
				</div>
			</div>
			<div style="margin-top: 1em;">
				<div>
					<span style="font-weight: bold;">Keyboard</span><br />
					<span>press key to play note<br />
					click on key to edit</span>
					<div style="display: flex; width: 100%; flex-wrap: wrap;">
						<template x-for="(key, k) in key_maps[curr_keymap]">
							<div style="border: 1px solid black; margin: 0.5em; padding: 0.5em; width: 10%;"
								 class="box"
								 :class="{'playing': playing.includes ( String (k) ) }">
								<!--<div x-html="JSON.stringify (playing.includes (n))"></div>-->
								<div style="display: flex; justify-content: space-between;">
									<div style="border: 1px solid black; padding: 5px; margin-bottom: 5px;" x-html="parseInt (k) + 1"></div>
									<input type="text"
										   class="kbc-button"
										   x-model="key_maps[curr_keymap][k]"
										   style="width: 3em; text-align: center;" />
									
									<div x-on:click="delete key_maps[curr_keymap][k]" title="delete" style="cursor: pointer; font-family: monospace;">[x]</div>
								</div>
								<!--<input type="text" x-model="key_maps[curr_keymap][k]" />-->
							</div>
						</template>
						<button x-on:click="add_keymap_degree()" style="cursor: pointer; margin: 0.5em;" title="add keyboard key">+</button>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>
